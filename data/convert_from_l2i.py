import torch
import os
import pickle
from torch import manual_seed
import math


def check_extension(filename):
    if os.path.splitext(filename)[1] != ".pkl":
        return filename + ".pkl"
    return filename


def save_dataset(dataset, filename):

    filedir = os.path.split(filename)[0]

    if not os.path.isdir(filedir):
        os.makedirs(filedir)

    with open(check_extension(filename), 'wb') as f:
        pickle.dump(dataset, f, pickle.HIGHEST_PROTOCOL)


def load_dataset(filename):

    with open(check_extension(filename), 'rb') as f:
        return pickle.load(f)

CAP = [5, -5, 2, -2, 7, -7, 7, -7, 9, -9, 4, -4, 5, -5, 5, -5, 9, -9, 8, -8]

DIST_MATRIX = [[0.0, 0.476656041127622, 0.2552811417236552, 0.9478079766996941, 0.6734523313668351, 0.3256711631083786, 0.5024727075545244, 0.7665737568852513, 0.9632153772376937, 0.23160059986422102, 0.39684632972711575, 0.818458928144617, 0.7850466138248411, 0.8250574172020254, 0.9174889663340017, 0.9442960077545058, 0.7231963825342294, 0.7890473488920857, 0.49912587311431333, 0.3881082448858752, 0.7582610282926028], [0.476656041127622, 0.0, 0.2883587133546384, 0.6243147717093512, 0.30980944540454236, 0.287286303138716, 0.025884602346175664, 0.8623286674666807, 0.7678274099843819, 0.3596575590661841, 0.25150325529276857, 0.8898594862899237, 0.800214262118384, 0.9138412839876965, 0.8577907018114619, 0.7022922892692696, 0.5282015638279828, 0.3126831916755979, 0.15269652057561453, 0.35187321302728736, 0.6434767382542359], [0.2552811417236552, 0.2883587133546384, 0.0, 0.6937328349302768, 0.4206751888538521, 0.07548941123170219, 0.3108000428674787, 0.6488779725173373, 0.7312224565632517, 0.07154241201129763, 0.14169951509536174, 0.6892708955586363, 0.6252034282016301, 0.7057728112256111, 0.7295974092702011, 0.7012300946477523, 0.48326491791296106, 0.5882546813352887, 0.25670204631769994, 0.15889712967447966, 0.5427751533058875], [0.9478079766996941, 0.6243147717093512, 0.6937328349302768, 0.0, 0.31488818615714637, 0.6221695060521496, 0.6108063244874953, 0.7288443498916102, 0.2748238493668819, 0.7220160375180815, 0.5523474349313281, 0.7110012809982115, 0.5952700402229489, 0.7464981001198339, 0.516961878956562, 0.17297510170195501, 0.27840062245171915, 0.5677750844483287, 0.49592798482669004, 0.5719958109539675, 0.37553773626367737], [0.6734523313668351, 0.30980944540454236, 0.4206751888538521, 0.31488818615714637, 0.0, 0.3607715173990783, 0.29752772233426716, 0.7247955770617792, 0.48137061364871375, 0.4674979779866281, 0.2846386112447136, 0.7328669104888629, 0.6231397317662575, 0.7640626151435977, 0.6284091960843277, 0.40321240154681753, 0.2768360527990122, 0.3435618701526578, 0.18655158621816667, 0.3469661138259622, 0.41639778275081807], [0.3256711631083786, 0.287286303138716, 0.07548941123170219, 0.6221695060521496, 0.3607715173990783, 0.0, 0.3057679641192377, 0.6011134161223934, 0.6559921115598413, 0.106739523331141, 0.07614030827158957, 0.6374606525235511, 0.5657110874416728, 0.6565354751849308, 0.6619257240853282, 0.6258816094575627, 0.4077798991048183, 0.5660219774226983, 0.215810896225846, 0.09019083028295269, 0.47026484815328407], [0.5024727075545244, 0.025884602346175664, 0.3108000428674787, 0.6108063244874953, 0.29752772233426716, 0.3057679641192377, 0.0, 0.87298072215165, 0.7624275562119306, 0.38181062614057043, 0.2651778166815818, 0.8990596725026603, 0.8072862962129108, 0.9237309986062501, 0.8601016258208056, 0.6942594394097616, 0.5260462729705138, 0.28703666313167003, 0.15321204569545255, 0.3664023083105651, 0.6448729185086786], [0.7665737568852513, 0.8623286674666807, 0.6488779725173373, 0.7288443498916102, 0.7247955770617792, 0.6011134161223934, 0.87298072215165, 0.0, 0.5184187982695032, 0.6003692952516216, 0.6127032518737149, 0.059846286326707736, 0.13858728495542577, 0.05861389214203033, 0.2877473873786692, 0.5876450927270624, 0.4809170009352476, 1.057766510400156, 0.7299131967501754, 0.5175632335405195, 0.3544948521964522], [0.9632153772376937, 0.7678274099843819, 0.7312224565632517, 0.2748238493668819, 0.48137061364871375, 0.6559921115598413, 0.7624275562119306, 0.5184187982695032, 0.0, 0.7329249903106606, 0.6063276442912857, 0.48553452334303543, 0.38002654678010556, 0.5205109042168123, 0.2594930045350778, 0.1019739762584007, 0.25128456583842024, 0.8006177472665793, 0.6176158480221066, 0.577931468991476, 0.22094767274771127], [0.23160059986422102, 0.3596575590661841, 0.07154241201129763, 0.7220160375180815, 0.4674979779866281, 0.106739523331141, 0.38181062614057043, 0.6003692952516216, 0.7329249903106606, 0.0, 0.18287917791174207, 0.6443243379427968, 0.5895780797594727, 0.6582206977168238, 0.7060383050276516, 0.7127187614196235, 0.4915980038179485, 0.6567981179532388, 0.3166864307876243, 0.15650774505384288, 0.5325892340531754], [0.39684632972711575, 0.25150325529276857, 0.14169951509536174, 0.5523474349313281, 0.2846386112447136, 0.07614030827158957, 0.2651778166815818, 0.6127032518737149, 0.6063276442912857, 0.18287917791174207, 0.0, 0.6430229141027275, 0.5601980859527697, 0.6654634962031062, 0.6391497933974711, 0.5678164636899061, 0.35525717158105097, 0.5053608716742723, 0.14917318472857177, 0.1015713445727501, 0.4360678264364327], [0.818458928144617, 0.8898594862899237, 0.6892708955586363, 0.7110012809982115, 0.7328669104888629, 0.6374606525235511, 0.8990596725026603, 0.059846286326707736, 0.48553452334303543, 0.6443243379427968, 0.6430229141027275, 0.0, 0.11671885346750789, 0.03559266787013431, 0.24201664670999895, 0.5616896576318157, 0.47699288395384043, 1.0707519749364525, 0.7526225457960851, 0.5513458615079444, 0.34260953168863284], [0.7850466138248411, 0.800214262118384, 0.6252034282016301, 0.5952700402229489, 0.6231397317662575, 0.5657110874416728, 0.8072862962129108, 0.13858728495542577, 0.38002654678010556, 0.5895780797594727, 0.5601980859527697, 0.11671885346750789, 0.0, 0.1517975751330669, 0.16493900455743124, 0.44979677274915647, 0.36179702741563124, 0.9638125170805614, 0.65738521324681, 0.47637741780940424, 0.22596413242821198], [0.8250574172020254, 0.9138412839876965, 0.7057728112256111, 0.7464981001198339, 0.7640626151435977, 0.6565354751849308, 0.9237309986062501, 0.05861389214203033, 0.5205109042168123, 0.6582206977168238, 0.6654634962031062, 0.03559266787013431, 0.1517975751330669, 0.0, 0.2744302837027133, 0.5972157462048223, 0.5107417980751361, 1.1006182597963254, 0.7787047470628955, 0.5718398597739542, 0.3774023881671981], [0.9174889663340017, 0.8577907018114619, 0.7295974092702011, 0.516961878956562, 0.6284091960843277, 0.6619257240853282, 0.8601016258208056, 0.2877473873786692, 0.2594930045350778, 0.7060383050276516, 0.6391497933974711, 0.24201664670999895, 0.16493900455743124, 0.2744302837027133, 0.0, 0.35047827388857755, 0.35160504265267756, 0.9708016077822924, 0.7068895822596294, 0.5721842521543673, 0.21641439960083278], [0.9442960077545058, 0.7022922892692696, 0.7012300946477523, 0.17297510170195501, 0.40321240154681753, 0.6258816094575627, 0.6942594394097616, 0.5876450927270624, 0.1019739762584007, 0.7127187614196235, 0.5678164636899061, 0.5616896576318157, 0.44979677274915647, 0.5972157462048223, 0.35047827388857755, 0.0, 0.221492072741674, 0.7087996352879488, 0.5565307768278657, 0.5562332259668892, 0.25228479386599073], [0.7231963825342294, 0.5282015638279828, 0.48326491791296106, 0.27840062245171915, 0.2768360527990122, 0.4077798991048183, 0.5260462729705138, 0.4809170009352476, 0.25128456583842024, 0.4915980038179485, 0.35525717158105097, 0.47699288395384043, 0.36179702741563124, 0.5107417980751361, 0.35160504265267756, 0.221492072741674, 0.0, 0.6197594503928104, 0.37570309867296003, 0.3350955291779645, 0.14177877223955154], [0.7890473488920857, 0.3126831916755979, 0.5882546813352887, 0.5677750844483287, 0.3435618701526578, 0.5660219774226983, 0.28703666313167003, 1.057766510400156, 0.8006177472665793, 0.6567981179532388, 0.5053608716742723, 1.0707519749364525, 0.9638125170805614, 1.1006182597963254, 0.9708016077822924, 0.7087996352879488, 0.6197594503928104, 0.0, 0.3567977078264984, 0.602198448579126, 0.7599301722420329], [0.49912587311431333, 0.15269652057561453, 0.25670204631769994, 0.49592798482669004, 0.18655158621816667, 0.215810896225846, 0.15321204569545255, 0.7299131967501754, 0.6176158480221066, 0.3166864307876243, 0.14917318472857177, 0.7526225457960851, 0.65738521324681, 0.7787047470628955, 0.7068895822596294, 0.5565307768278657, 0.37570309867296003, 0.3567977078264984, 0.0, 0.24564903392199267, 0.49175450357804196], [0.3881082448858752, 0.35187321302728736, 0.15889712967447966, 0.5719958109539675, 0.3469661138259622, 0.09019083028295269, 0.3664023083105651, 0.5175632335405195, 0.577931468991476, 0.15650774505384288, 0.1015713445727501, 0.5513458615079444, 0.47637741780940424, 0.5718398597739542, 0.5721842521543673, 0.5562332259668892, 0.3350955291779645, 0.602198448579126, 0.24564903392199267, 0.0, 0.3841907473143429], [0.7582610282926028, 0.6434767382542359, 0.5427751533058875, 0.37553773626367737, 0.41639778275081807, 0.47026484815328407, 0.6448729185086786, 0.3544948521964522, 0.22094767274771127, 0.5325892340531754, 0.4360678264364327, 0.34260953168863284, 0.22596413242821198, 0.3774023881671981, 0.21641439960083278, 0.25228479386599073, 0.14177877223955154, 0.7599301722420329, 0.49175450357804196, 0.3841907473143429, 0.0]]

DEPOT = [0.95376258, 0.99212647]

LOC = [[0.47960292, 0.94340686],
       [0.74877503, 0.83997995],
       [0.24222936, 0.36597918],
       [0.37199461, 0.65288605],
       [0.71176244, 0.77418694],
       [0.45412181, 0.93885435],
       [0.9574195,  0.22556144],
       [0.44132418, 0.1765342 ],
       [0.8129109,  0.80827968],
       [0.63974336, 0.74947664],
       [0.92685265, 0.17411005],
       [0.81900054, 0.21873305],
       [0.96174972, 0.16710771],
       [0.69280071, 0.11253287],
       [0.37026945, 0.24967734],
       [0.51601469, 0.41646182],
       [0.16726188, 0.92878325],
       [0.49666055, 0.79166608],
       [0.71754643, 0.68418177],
       [0.6141746,  0.31415907]
]

GRAPH_SIZE = 20
NAME = "L2I_TEST"
SEED = 1234


CAPACITIES = {
    10: 10., #20., I divided by 2 from original because there are fewer calls that is picked up.
    20: 15., #30.
    50: 20., #40.
    100: 25. #50.
}
dataset = []
num_samples = 100
for i in range(num_samples):
    demand = torch.FloatTensor(CAP) / CAPACITIES[GRAPH_SIZE]
    locs = torch.FloatTensor(LOC)
    print(demand, locs)
    diffs = (locs[1::2] - locs[0:-1:2])
    dataset += [
        {
            'loc': locs,
            # Uniform 1 - 9, scaled by capacities
            'demand': demand,
            'depot': torch.FloatTensor(DEPOT),
            'type': torch.FloatTensor([True, False]).repeat(GRAPH_SIZE//2),
            'p_or_d': torch.flatten(torch.stack((locs[1::2], locs[::2]), dim=1), start_dim=0, end_dim=1),
            'dist': torch.flatten(torch.stack((diffs.norm(p=2, dim=1), torch.zeros(10)), dim=1), start_dim=0, end_dim=1),
            'angle': torch.flatten(torch.stack(((1.5*math.pi - torch.atan2(diffs[:, 0], diffs[:, 1])),
                                                torch.zeros(10)), dim=1), start_dim=0, end_dim=1)
        }
    ]

save_dataset(dataset, f'pdp/pdp{GRAPH_SIZE}_{NAME}_seed{SEED}.pkl')